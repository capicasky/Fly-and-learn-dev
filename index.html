<script>
const icaoInput = document.getElementById("icao");
const resultBox = document.getElementById("result");

/* === WIND COMPONENT AUTO ‚Äì DATA === */
const airportRunways = {
  MROC:{runways:[{id:"07",h:70},{id:"25",h:250}]},
  MRPV:{runways:[{id:"10",h:100},{id:"28",h:280}]},
  MRLB:{runways:[{id:"07",h:70},{id:"25",h:250}]},
  MRLM:{runways:[{id:"05",h:50},{id:"23",h:230}]}
};

/* ---------- METAR ---------- */
async function getMetar(){
  const icao = icaoInput.value.trim().toUpperCase();
  if(icao.length !== 4) return;

  resultBox.style.display = "block";
  resultBox.innerHTML = "Loading METAR...";

  try{
    const url = `https://aviationweather.gov/api/data/metar?ids=${icao}&format=raw&hours=1`;
    const r = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
    const raw = (await r.text()).trim();

    if(!raw){
      resultBox.innerHTML = "No METAR available.";
      return;
    }

    const zulu = raw.match(/\d{6}Z/);
    const highlighted = zulu
      ? raw.replace(zulu[0], `<span class="zulu">${zulu[0]}</span>`)
      : raw;

    let html = `<strong>RAW METAR</strong>\n${highlighted}\n`;
    html += decodeMetar(raw);
    html += buildWindComponent(raw, icao);

    resultBox.innerHTML = html;

  }catch(e){
    resultBox.innerHTML = "Error retrieving METAR.";
    console.error(e);
  }
}

/* ---------- TAF ---------- */
async function getTaf(){
  const icao = icaoInput.value.trim().toUpperCase();
  if(icao.length !== 4) return;

  resultBox.style.display = "block";
  resultBox.innerHTML = "Loading TAF...";

  try{
    const url = `https://aviationweather.gov/api/data/taf?ids=${icao}&format=raw`;
    const r = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
    const raw = (await r.text()).trim();

    if(!raw){
      resultBox.innerHTML = "No TAF available for this airport.";
      return;
    }

    let html = `<strong>RAW TAF</strong>\n${raw}\n`;
    html += decodeTaf(raw);

    resultBox.innerHTML = html;

  }catch(e){
    resultBox.innerHTML = "Error retrieving TAF.";
    console.error(e);
  }
}

/* ---------- DECODE METAR ---------- */
function decodeMetar(raw){
  let html = `<div class="decoded"><div class="decoded-title">Decoded METAR</div>`;

  const wind = raw.match(/(\d{3}|VRB)(\d{2})(G\d{2})?KT/);
  if(wind){
    html += `üå¨Ô∏è Wind: ${wind[1]}¬∞ ${wind[2]} kt`;
    if(wind[3]) html += ` (gust ${wind[3].slice(1)} kt)`;
    html += `<br>`;
  }

  const vis = raw.match(/ (\d{1,2})SM/);
  if(vis){
    html += `üëÅÔ∏è Visibility: ${vis[1]} SM<br>`;
  }

  const clouds = raw.match(/(FEW|SCT|BKN|OVC)\d{3}/g);
  if(clouds){
    html += `‚òÅÔ∏è Clouds: ${clouds.join(", ")}<br>`;
  }

  const temp = raw.match(/ (M?\d{2})\/(M?\d{2}) /);
  if(temp){
    html += `üå°Ô∏è Temp / Dew: ${temp[1].replace("M","-")}¬∞C / ${temp[2].replace("M","-")}¬∞C<br>`;
  }

  const alt = raw.match(/A(\d{4})/);
  if(alt){
    html += `üéöÔ∏è Altimeter: ${(alt[1]/100).toFixed(2)} inHg<br>`;
  }

  return html + `</div>`;
}

/* ---------- DECODE TAF ---------- */
function decodeTaf(raw){
  let html = `<div class="decoded"><div class="decoded-title">Decoded TAF (Basic)</div>`;

  const wind = raw.match(/(\d{3}|VRB)(\d{2})(G\d{2})?KT/);
  if(wind){
    html += `üå¨Ô∏è Wind: ${wind[1]}¬∞ ${wind[2]} kt<br>`;
  }

  const vis = raw.match(/ (\d{1,2})SM/);
  if(vis){
    html += `üëÅÔ∏è Visibility: ${vis[1]} SM<br>`;
  }

  const clouds = raw.match(/(FEW|SCT|BKN|OVC)\d{3}/g);
  if(clouds){
    html += `‚òÅÔ∏è Clouds: ${clouds.join(", ")}<br>`;
  }

  const tempo = raw.match(/TEMPO\s([^=]+)/);
  if(tempo){
    html += `‚è±Ô∏è TEMPO: ${tempo[1]}<br>`;
  }

  html += `<small>Basic decoding for training purposes</small></div>`;
  return html;
}

/* ---------- WIND COMPONENT ---------- */
function buildWindComponent(raw, icao){
  if(!airportRunways[icao]) return "";

  const windMatch = raw.match(/(VRB|\d{3})(\d{2})(G\d{2})?KT/);
  if(!windMatch) return "";

  if(windMatch[1] === "VRB"){
    return `<div class="decoded"><div class="decoded-title">Wind Component</div>
    Variable wind ‚Äì auto calculation not available</div>`;
  }

  const windDir = parseInt(windMatch[1]);
  const windSpd = parseInt(windMatch[2]);

  let html = `<div class="decoded"><div class="decoded-title">Wind Component (Auto)</div>`;

  airportRunways[icao].runways.forEach(r=>{
    let diff = Math.abs(windDir - r.h);
    if(diff > 180) diff = 360 - diff;

    let head = Math.round(windSpd * Math.cos(diff * Math.PI / 180));
    let cross = Math.round(windSpd * Math.sin(diff * Math.PI / 180));

    html += `RWY ${r.id}<br>`;
    html += head >= 0
      ? `<span class="hw">Headwind</span>: ${head} kt<br>`
      : `<span class="tw-danger">Tailwind</span>: ${Math.abs(head)} kt<br>`;

    html += `Crosswind: ${Math.abs(cross)} kt<br><br>`;
  });

  return html + `<small>Training use only</small></div>`;
}
</script>
