<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">


<!-- iOS Home Screen -->
<link rel="apple-touch-icon" href="icon-180.png">

<!-- Android / PWA icons -->
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">


<!-- Configuraci√≥n b√°sica para m√≥viles y PWA -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#f4f1e8">

<title>Fly and Learn ‚Äì Aviation Tools</title>




<style>
/* ======================================================
   ESTILOS GENERALES (COLORES, FUENTES, FONDO)
   Aqu√≠ solo se define c√≥mo se ve la p√°gina
   NO hay l√≥gica ni c√°lculos
====================================================== */

body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  background-color: #f4f1e8;
  color: #355f5b;
}

* { box-sizing: border-box; }

/* ======================================================
   CONTENEDOR PRINCIPAL (TARJETA CENTRAL)
====================================================== */

.container {
  max-width: 420px;
  margin: 20px auto;
  background: #ffffff;
  padding: 22px;
  border-radius: 14px;
  box-shadow: 0 6px 14px rgba(0,0,0,0.12);
}

/* T√≠tulos */
h1 {
  text-align:center;
  color:#6fa89a;
  margin-bottom:4px;
}

.subtitle {
  text-align:center;
  font-size:13px;
  margin-bottom:16px;
  color:#4a6a78;
}

/* ======================================================
   INPUT ICAO
====================================================== */

.icao-input {
  width:100%;
  height:40px;
  padding:4px 8px;
  font-size:16px;
  text-align:center;
  letter-spacing:2px;
  border-radius:10px;
   border:1px solid #1f6fb2;
}

/* ======================================================
   BOTONES
====================================================== */

.buttons-row {
  display:flex;
  gap:10px;
  margin-top:16px;
}

.primary-btn {
  padding:12px;
  font-size:15px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  background:#6fa89a;
  color:white;
}

.primary-btn.half { width:50%; }
.primary-btn.notam { width:70%; }

.primary-btn:hover {
  background:#5e9c8c;
}

.buttons-notam {
  margin-top:12px;
  text-align:center;
}

/* ======================================================
   CAJA DE RESULTADOS (METAR / TAF / WIND)
====================================================== */

.result-box {
  margin-top:18px;
  padding:14px;
  border-radius:10px;
  background:#eaf4fa;
  border:1px solid #8ecae6;
  font-family:"Courier New", monospace;
  font-size:14px;
  background-color: a786af;
  border-left: #1f6fb2 5px solid;
  border-right: #1f6fb2 5px solid;
  display:none; /* Se muestra solo cuando hay datos */
}

/* ======================================================
   SECCIONES INTERNAS DEL RESULTADO
====================================================== */

.section-title {
  text-align:center;
  font-weight:bold;
  margin:12px 0 6px;
}

.section-raw {
  background:#fff;
  border:1px solid #d6e4ec;
  border-radius:8px;
  padding:10px;
  margin-bottom:10px;
}

/* Secci√≥n especial para viento */
.section-wind {
  background-color: white;
  padding:10px;
  margin-bottom:10px;
}

/* Colores para headwind / tailwind */
.hw { color:#1f6fb2; font-weight:bold; }
.tw-danger { color:#c0392b; font-weight:bold; }

/* ======================================================
   FOOTER
====================================================== */

.footer {
  text-align:center;
  font-size:12px;
  margin-top:18px;
  color:#4a6a78;
}

/* ======================================================
   LINK PDF C√ìDIGOS METAR / TAF
====================================================== */

.codes-link {
  display:inline-block;
  margin-top:12px;
  padding:6px 10px;
  border:1px solid #8ecae6;
  border-radius:8px;
  font-size:13px;
  color:#355f5b;
  text-decoration:none;
  background:#ffffff;
}

.codes-link:hover {
  background:#eaf4fa;
}

  .app-time {
  text-align: center;
  font-size: 12px;
  color: #6b7c85;
  margin-bottom: 14px;
  font-weight: bold;
}
   .cw-warning {
  color: #f1c40f; /* amarillo */
  font-weight: bold;
}


</style>
</head>

<body>

<!-- ======================================================
     CONTENIDO VISIBLE DE LA APP
====================================================== -->

<div class="container">

  <h1>Fly and Learn</h1>
  <div class="subtitle">Aviation study tools ‚Äì student use only</div>
  <div id="localTime" class="app-time"></div>

  <!-- Campo donde el usuario escribe el ICAO -->
  <input id="icao" class="icao-input" maxlength="4" placeholder="Enter ICAO">

  <!-- Botones METAR y TAF -->
  <div class="buttons-row">
    <button class="primary-btn half" onclick="getMetar()">METAR</button>
    <button class="primary-btn half" onclick="getTaf()">TAF</button>
  </div>

  <!-- Bot√≥n NOTAM (a√∫n sin l√≥gica) -->
  <div class="buttons-notam">
    <button class="primary-btn notam">NOTAM</button>
  </div>

  <!-- Aqu√≠ se muestran los resultados -->
  <div id="result" class="result-box"></div>

  <!-- Link a PDF de c√≥digos -->
  <div style="text-align:center;">
    <a class="codes-link" href="metar_taf_codes.pdf" target="_blank">
      üìÑ METAR &amp; TAF Codes (PDF)
    </a>
  </div>

  <!-- Firma -->
  <div class="footer">
    Fly smart<br>
    Capi Casky
  </div>

</div>

<script>
/* ======================================================
   JAVASCRIPT ‚Äì L√ìGICA DE LA APLICACI√ìN
   Aqu√≠ es donde pasan las cosas (fetch, c√°lculos, etc.)
====================================================== */

document.addEventListener("DOMContentLoaded", () => {

  /* Referencias a elementos HTML */
  const icaoInput = document.getElementById("icao");
  const resultBox = document.getElementById("result");

  // Ejecutar METAR al presionar ENTER en el campo ICAO
icaoInput.addEventListener("keydown", function(event) {
  if (event.key === "Enter") {
    event.preventDefault();
    getMetar();
  }
});

// Limpiar resultados cuando el ICAO queda vac√≠o
icaoInput.addEventListener("input", function () {
  if (icaoInput.value.trim() === "") {
    resultBox.innerHTML = "";
    resultBox.style.display = "none";
  }
});

const timeBox = document.getElementById("localTime");

function updateLocalTime() {
  const now = new Date();

  const day = String(now.getDate()).padStart(2, "0");
  const month = String(now.getMonth() + 1).padStart(2, "0");
  const year = String(now.getFullYear()).slice(-2);

  const hours = String(now.getHours()).padStart(2, "0");
  const minutes = String(now.getMinutes()).padStart(2, "0");
  const seconds = String(now.getSeconds()).padStart(2, "0");

  timeBox.textContent = `Date: ${day}/${month}/${year} ¬∑ Local time: ${hours}:${minutes}:${seconds}`;
}

// Ejecutar una vez y luego cada segundo
updateLocalTime();
setInterval(updateLocalTime, 1000);


  /* ======================================================
     BASE DE DATOS SIMPLE DE PISTAS
     SOLO estos aeropuertos tienen wind component y elevacion
  ====================================================== */

  const airportRunways = {
  MROC:{
    elevation: 3048,
    runways:[{id:"07",h:70},{id:"25",h:250}]
  },
  MRPV:{
    elevation: 3287,
    runways:[{id:"10",h:100},{id:"28",h:280}]
  },
  MRLB:{
    elevation: 272,
    runways:[{id:"07",h:70},{id:"25",h:250}]
  },
  MRLM:{
    elevation: 7,
    runways:[{id:"05",h:50},{id:"23",h:230}]
  }
};


  /* ======================================================
     FUNCI√ìN METAR
     - Valida ICAO
     - Descarga METAR
     - Muestra RAW + wind component
  ====================================================== */

  window.getMetar = async function(){
    const icao = icaoInput.value.trim().toUpperCase();
     

  if(icao.length !== 4) return;

    resultBox.style.display = "block";
    resultBox.textContent = "Loading METAR...";

    const url = `https://aviationweather.gov/api/data/metar?ids=${icao}&format=raw&hours=12`;
    const r = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
    const raw = (await r.text()).trim().split("\n")[0];
    const airportData = airportRunways[icao];
    const airportElevation = airportData?.elevation ?? null;



    // ==============================
// METAR TIME (SINGLE SOURCE)
// ==============================
let metarDay = null;
let metarHour = null;
let metarMin = null;

const metarTimeMatch = raw.match(/(\d{2})(\d{2})(\d{2})Z/);
if (metarTimeMatch) {
  metarDay = parseInt(metarTimeMatch[1], 10);
  metarHour = parseInt(metarTimeMatch[2], 10);
  metarMin = parseInt(metarTimeMatch[3], 10);
}
    
    // ==============================
// METAR DECODED ‚Äì TIME (Z)
// ==============================
let decodedTime = "";

if (metarDay !== null) {
  decodedTime = `Day ${String(metarDay).padStart(2,"0")} at ${String(metarHour).padStart(2,"0")}:${String(metarMin).padStart(2,"0")} Z`;
}


  // ==============================
// METAR DECODED ‚Äì WIND
// ==============================
let decodedWind = "";

const windMatch = raw.match(/(VRB|\d{3})(\d{2,3})(G\d{2,3})?KT/);
if (windMatch) {
  const dir = windMatch[1];
  const spd = windMatch[2];
  const gst = windMatch[3];

  if (dir === "VRB") {
    decodedWind = `Variable at ${spd} kt`;
  } else {
    decodedWind = `${dir}¬∞ at ${spd} kt`;
  }

  if (gst) {
    decodedWind += ` (gusting ${gst.replace("G", "")} kt)`;
  }
}

   // ==============================
// METAR DECODED ‚Äì VISIBILITY
// ==============================
let decodedVisibility = "";

 const visMatch = raw.match(/\b(\d{4})\b/);


if (visMatch) {
  const visMeters = parseInt(visMatch[1], 10);

  if (visMeters === 9999) {
    decodedVisibility = "10 km or more";
  } else {
    decodedVisibility = `${visMeters / 1000} km`;
  }
}

// ==============================
// METAR DECODED ‚Äì CLOUDS
// ==============================
let decodedClouds = [];
const cloudMatches = raw.match(/\b(FEW|SCT|BKN|OVC)\d{3}(CB|TCU)?\b/g);
if (cloudMatches) {
  cloudMatches.forEach(c => {
    const type = c.substring(0, 3);
    const height = parseInt(c.substring(3, 6), 10) * 100;

    let description = "";

    switch (type) {
      case "FEW": description = "Few clouds"; break;
      case "SCT": description = "Scattered clouds"; break;
      case "BKN": description = "Broken clouds"; break;
      case "OVC": description = "Overcast"; break;
    }

    decodedClouds.push(`${description} at ${height.toLocaleString()} ft`);
  });
}
      // ==============================
// METAR DECODED ‚Äì ceilling
// ==============================
let decodedCeiling = "";
    
   if (cloudMatches) {
  for (let c of cloudMatches) {
    const type = c.substring(0, 3);

    if (type === "BKN" || type === "OVC") {
      const height = parseInt(c.substring(3, 6), 10) * 100;
      decodedCeiling = `${height.toLocaleString()} ft`;
      break; // el primer BKN/OVC es el ceiling
    }
  }
}
 
      // ==============================
      // METAR DECODED ‚Äì temp and dew point
      // ==============================


      let decodedTemp = "";
      let decodedDew = "";

    const tempMatch = raw.match(/\b(M?\d{2})\/(M?\d{2})\b/);

    let oat = null;
   

if (tempMatch) {
  
  
  const tempRaw = tempMatch[1];
  const dewRaw = tempMatch[2];

  const temp = tempRaw.startsWith("M")
    ? -parseInt(tempRaw.slice(1))
    : parseInt(tempRaw);

  const dew = dewRaw.startsWith("M")
    ? -parseInt(dewRaw.slice(1))
    : parseInt(dewRaw);

  decodedTemp = `${temp} ¬∞C`;
  decodedDew = `${dew} ¬∞C`;
   oat = temp; // Outside Air Temperature en ¬∞C

}

// ==============================
// METAR DECODED ‚Äì QNH (inHg)
// ==============================
let decodedQNH = "";

const qnhMatch = raw.match(/\bA(\d{4})\b/);

if (qnhMatch) {
  const qnhRaw = qnhMatch[1]; // ej: 2992
  decodedQNH = `${(qnhRaw / 100).toFixed(2)} inHg`;
}

// ==============================
// PERFORMANCE ‚Äì PRESSURE ALTITUDE
// ==============================

let pressureAltitude = "";

if (airportElevation && decodedQNH) {
     const qnhValue = parseFloat(decodedQNH.replace(" inHg", ""));
     pressureAltitude = Math.round(
    airportElevation + (29.92 - qnhValue) * 1000
  );
}

 let isaTemp = "";

if (airportElevation !== null) {
  isaTemp = 15 - (2 * (airportElevation / 1000));
}
 
let densityAltitude = "";

if (pressureAltitude && oat !== null && isaTemp !== "") {

  densityAltitude = Math.round(
    pressureAltitude + (120 * (oat - isaTemp))
  );
}

     

      // Extraer hora del METAR (DDHHMMZ)
let isExpired = false;

if (metarDay !== null) {
  const now = new Date();
  const metarUTC = new Date(Date.UTC(
    now.getUTCFullYear(),
    now.getUTCMonth(),
    metarDay,
    metarHour,
    metarMin
  ));


  const diffMinutes = (Date.now() - metarUTC.getTime()) / 60000;


  if (diffMinutes > 90) {
    isExpired = true;
  }
}

   if(!raw || raw.startsWith("{")){
      resultBox.textContent = "METAR not available.";
      return;
    }

  let html = `<div class="section-title">‚úàÔ∏è METAR</div>`;

if (isExpired) {
  html += `<div style="text-align:center; font-size:12px; color:#c0392b; margin-bottom:6px;">
    ‚ö†Ô∏è METAR expired (last available report)
  </div>`;
}

html += `<div class="section-raw"><strong>RAW</strong><br>${raw}</div>`;

if (
  decodedTime ||
  decodedWind ||
  decodedVisibility ||
  decodedClouds.length ||
  decodedCeiling ||
  decodedTemp ||
  decodedDew ||
  decodedQNH 
  ) 
  {


  html += `<div class="section-raw">
    <strong>DECODED</strong><br>
    ${decodedTime ? `Time: ${decodedTime}<br>` : ""}
    ${decodedWind ? `Wind: ${decodedWind}<br>` : ""}
    ${decodedVisibility ? `Visibility: ${decodedVisibility}<br>` : ""}
    ${decodedClouds.length ? `Clouds: ${decodedClouds.join(", ")}<br>` : ""}
    ${decodedCeiling ? `Ceiling: ${decodedCeiling}<br>` : ""}
    ${decodedTemp ? `Temperature: ${decodedTemp}<br>` : ""}
    ${decodedDew ? `Dew point: ${decodedDew}<br>` : ""}
    ${decodedQNH ? `Altimeter: ${decodedQNH}<br>` : ""}

 </div>`;
}
    // cuadro performance)

if (airportElevation) {

  html += `<div class="section-raw">
    <strong>PERFORMANCE</strong><br>
    Field elevation: ${airportElevation.toLocaleString()} ft<br>
    ${pressureAltitude
      ? `Pressure altitude: ${pressureAltitude.toLocaleString()} ft<br>`
      : `Pressure altitude: ‚Äî<br>`
    }
    ${densityAltitude
      ? `Density altitude: ${densityAltitude.toLocaleString()} ft`
      : `Density altitude: ‚Äî`
    }
  </div>`;

}




html += buildWindComponent(raw, icao);

    resultBox.innerHTML = html;
  }

  /* ======================================================
     FUNCI√ìN WIND COMPONENT
     - Calcula headwind / tailwind
     - Calcula crosswind izquierda / derecha
  ====================================================== */

  function buildWindComponent(raw, icao) {

  if(!airportRunways[icao]){
  return "";
}


    const w = raw.match(/(VRB|\d{3})(\d{2,3})(G\d{2,3})?KT/);
    if (!w) {
      return `<div class="section-wind"><strong>Wind Component</strong><br>Wind data not available</div>`;
    }

    const isVRB = w[1] === "VRB";
    const windDir = isVRB ? null : parseInt(w[1]);
    const windSpd = parseInt(w[2]);

    let html = `<div class="section-wind"><strong>Wind Component</strong><br>`;

    airportRunways[icao].runways.forEach(r => {

      html += `RWY ${r.id}<br>`;

      if (isVRB) {
        html += `Wind: Variable ${windSpd} kt<br>`;
        html += `Crosswind: variable<br><br>`;
        return;
      }

      let diff = windDir - r.h;
      if (diff > 180) diff -= 360;
      if (diff < -180) diff += 360;

      let head = Math.round(windSpd * Math.cos(diff * Math.PI / 180));
      let cross = Math.round(windSpd * Math.sin(diff * Math.PI / 180));

      let side = cross > 0 ? "from the RIGHT" : cross < 0 ? "from the LEFT" : "";

      if (head > 0) {
        html += `<span class="hw">Headwind</span>: ${head} kt<br>`;
      } else if (head < 0) {
        html += `<span class="tw-danger">Tailwind</span>: ${Math.abs(head)} kt<br>`;
      } else {
        html += `Headwind: 0 kt<br>`;
      }

    if (Math.abs(cross) <= 2) {
  html += `Crosswind: insignificant<br><br>`;
} else {
  html += `<span class="cw-warning">Crosswind</span>: ${Math.abs(cross)} kt (${side})<br><br>`;
}

    });

    return html + `<small>Training use only</small></div>`;
  }

});
</script>


</body>
</html>
